<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo Room</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #36393f;
            color: #dcddde;
            overflow: hidden;
        }
        
        /* Auth */
        .auth-screen {
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #5865f2 0%, #7289da 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .auth-box {
            background: #36393f;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            width: 480px;
        }
        .auth-box h1 {
            color: #fff;
            font-size: 28px;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-field {
            margin-bottom: 20px;
        }
        .form-field label {
            display: block;
            color: #b9bbbe;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .form-field input {
            width: 100%;
            background: #202225;
            border: 1px solid #202225;
            color: #dcddde;
            padding: 10px;
            border-radius: 3px;
            font-size: 16px;
        }
        .form-field input:focus {
            outline: none;
            border-color: #5865f2;
        }
        .auth-btn {
            width: 100%;
            background: #5865f2;
            color: #fff;
            border: none;
            padding: 12px;
            border-radius: 3px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .auth-btn:hover { background: #4752c4; }
        .auth-btn.secondary {
            background: transparent;
            color: #5865f2;
        }
        .error { color: #f04747; font-size: 14px; margin-top: 10px; }
        
        /* Main App */
        .main-app {
            display: none;
            width: 100vw;
            height: 100vh;
        }
        .app-container {
            display: flex;
            height: 100%;
        }
        
        /* Servers Bar */
        .servers-bar {
            width: 72px;
            background: #202225;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 0;
        }
        .server-icon {
            width: 48px;
            height: 48px;
            background: #36393f;
            border-radius: 50%;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .server-icon:hover {
            border-radius: 16px;
            background: #5865f2;
        }
        .server-icon.active {
            border-radius: 16px;
            background: #5865f2;
        }
        
        /* Channels */
        .channels-sidebar {
            width: 240px;
            background: #2f3136;
            display: flex;
            flex-direction: column;
        }
        .server-header {
            height: 48px;
            padding: 0 16px;
            border-bottom: 1px solid #202225;
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #fff;
        }
        .channels-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        .channel-item {
            padding: 8px;
            margin: 2px 0;
            border-radius: 4px;
            color: #96989d;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .channel-item:hover {
            background: #3c3f45;
            color: #dcddde;
        }
        .channel-item.active {
            background: #404249;
            color: #fff;
        }
        .channel-item::before {
            content: '#';
            margin-right: 6px;
            font-weight: 600;
        }
        .channel-item.voice::before {
            content: 'ðŸ”Š';
        }
        
        /* User Panel */
        .user-panel {
            height: 52px;
            background: #292b2f;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .user-info {
            display: flex;
            align-items: center;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #5865f2;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 600;
        }
        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }
        .logout-btn {
            background: #ed4245;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        /* Chat */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            height: 48px;
            border-bottom: 1px solid #202225;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .channel-name {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }
        .voice-btns {
            display: flex;
            gap: 8px;
        }
        .voice-btn {
            background: #3ba55d;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        .voice-btn:hover { background: #2d7d46; }
        .voice-btn.disconnect { background: #ed4245; }
        .voice-btn.disconnect:hover { background: #c03537; }
        
        /* Messages */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        .message {
            display: flex;
            margin-bottom: 20px;
        }
        .message:hover { background: #32353b; padding: 2px 16px; margin: 0 -16px 20px -16px; }
        .msg-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #5865f2;
            margin-right: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 600;
        }
        .msg-content {
            flex: 1;
        }
        .msg-header {
            display: flex;
            align-items: baseline;
            margin-bottom: 4px;
        }
        .msg-author {
            font-weight: 600;
            color: #fff;
            margin-right: 8px;
        }
        .msg-time {
            font-size: 12px;
            color: #72767d;
        }
        .msg-text {
            color: #dcddde;
            line-height: 1.4;
        }
        
        /* Voice Message */
        .voice-msg {
            background: #2f3136;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            max-width: 350px;
        }
        .voice-play {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #5865f2;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
        }
        .voice-wave {
            flex: 1;
            height: 24px;
            background: #1e1f22;
            border-radius: 4px;
        }
        .voice-time {
            font-size: 12px;
            color: #b9bbbe;
        }
        
        /* Input */
        .input-area {
            padding: 16px;
        }
        .input-wrapper {
            background: #40444b;
            border-radius: 8px;
            padding: 0 16px;
            display: flex;
            align-items: center;
        }
        .msg-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #dcddde;
            padding: 12px 8px;
            font-size: 15px;
        }
        .msg-input:focus { outline: none; }
        .msg-input::placeholder { color: #72767d; }
        .record-btn {
            background: none;
            border: none;
            color: #b9bbbe;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
        }
        .record-btn:hover { color: #dcddde; }
        .record-btn.recording {
            color: #ed4245;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* DM List */
        .dm-list {
            display: none;
        }
        .dm-list.active {
            display: flex;
            flex-direction: column;
        }
        .friend-item {
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            margin: 2px 0;
        }
        .friend-item:hover {
            background: #3c3f45;
        }
        .friend-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #5865f2;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 600;
        }
        .friend-name {
            color: #dcddde;
        }
        
        /* Voice Panel */
        .voice-panel {
            position: fixed;
            bottom: 0;
            left: 312px;
            right: 0;
            height: 100px;
            background: #232428;
            border-top: 1px solid #1e1f22;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }
        .voice-panel.active { display: flex; }
        .voice-control {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            background: #3c3f45;
            border: none;
            color: #dcddde;
            cursor: pointer;
            font-size: 18px;
        }
        .voice-control:hover { background: #4e5158; }
        .voice-control.active { background: #5865f2; }
        
        /* Screen Share */
        .screen-viewer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .screen-viewer.active { display: flex; }
        .screen-video {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }
        .close-screen {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ed4245;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 20px;
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2e3338; }
        ::-webkit-scrollbar-thumb { background: #202225; border-radius: 4px; }
    </style>
</head>
<body>
    <!-- Auth -->
    <div id="auth" class="auth-screen">
        <div class="auth-box">
            <h1>ðŸ”Š Echo Room</h1>
            <div id="auth-form"></div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="main-app">
        <div class="app-container">
            <!-- Servers -->
            <div class="servers-bar">
                <div class="server-icon active" onclick="showServer('welcome')">ðŸŽ®</div>
                <div class="server-icon" onclick="showDM()">@</div>
            </div>

            <!-- Channels/DMs -->
            <div class="channels-sidebar">
                <div class="server-header" id="server-name">Welcome Server</div>
                
                <!-- Channels List -->
                <div class="channels-list" id="channels-list"></div>
                
                <!-- DM List -->
                <div class="dm-list" id="dm-list"></div>
                
                <!-- User Panel -->
                <div class="user-panel">
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar">U</div>
                        <div class="user-name" id="user-name">User</div>
                    </div>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>

            <!-- Chat -->
            <div class="chat-area">
                <div class="chat-header">
                    <div class="channel-name" id="channel-title"># general</div>
                    <div class="voice-btns" id="voice-controls"></div>
                </div>
                <div class="messages" id="messages"></div>
                <div class="input-area">
                    <div class="input-wrapper">
                        <input type="text" class="msg-input" id="msg-input" placeholder="Message..." onkeypress="handleEnter(event)">
                        <button class="record-btn" id="record-btn" onclick="toggleRecord()" style="display:none;">ðŸŽ¤</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Voice Panel -->
    <div class="voice-panel" id="voice-panel">
        <button class="voice-control" onclick="toggleMute()">ðŸ”‡</button>
        <button class="voice-control disconnect" onclick="leaveVoice()">ðŸ“ž</button>
        <button class="voice-control" onclick="shareScreen()">ðŸ“º</button>
    </div>

    <!-- Screen Viewer -->
    <div class="screen-viewer" id="screen-viewer">
        <button class="close-screen" onclick="closeScreen()">âœ•</button>
        <video class="screen-video" id="screen-video" autoplay></video>
    </div>

    <script>
        const URL = window.location.origin;
        let socket, user, currentServer = 'welcome', currentChannel = 'general', isDM = false;
        let localStream, screenStream, peerConnections = {}, mediaRecorder, audioChunks = [];
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        // Init
        window.onload = async () => {
            const token = localStorage.getItem('token');
            if (token) {
                try {
                    const res = await fetch(`${URL}/api/auth/session/${token}`);
                    const data = await res.json();
                    if (data.success) {
                        user = data.user;
                        showApp();
                        return;
                    }
                } catch(e) {}
            }
            showLogin();
        };

        // Auth
        function showLogin() {
            document.getElementById('auth-form').innerHTML = `
                <div class="form-field">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="your@email.com">
                </div>
                <div class="form-field">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button class="auth-btn" onclick="login()">Login</button>
                <button class="auth-btn secondary" onclick="showSignup()">Sign Up</button>
                <div id="error"></div>
            `;
        }

        function showSignup() {
            document.getElementById('auth-form').innerHTML = `
                <div class="form-field">
                    <label>Username</label>
                    <input type="text" id="username" placeholder="cooluser">
                </div>
                <div class="form-field">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="your@email.com">
                </div>
                <div class="form-field">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button class="auth-btn" onclick="signup()">Create Account</button>
                <button class="auth-btn secondary" onclick="showLogin()">Back</button>
                <div id="error"></div>
            `;
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                const res = await fetch(`${URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, password})
                });
                const data = await res.json();
                if (data.success) {
                    localStorage.setItem('token', data.session_token);
                    user = data.user;
                    showApp();
                } else {
                    document.getElementById('error').innerHTML = `<div class="error">${data.error}</div>`;
                }
            } catch(e) {
                document.getElementById('error').innerHTML = '<div class="error">Connection error</div>';
            }
        }

        async function signup() {
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                const res = await fetch(`${URL}/api/auth/signup`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, email, password})
                });
                const data = await res.json();
                if (data.success) {
                    localStorage.setItem('token', data.session_token);
                    user = data.user;
                    showApp();
                } else {
                    document.getElementById('error').innerHTML = `<div class="error">${data.error}</div>`;
                }
            } catch(e) {
                document.getElementById('error').innerHTML = '<div class="error">Connection error</div>';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            location.reload();
        }

        // App
        function showApp() {
            document.getElementById('auth').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('user-name').textContent = user.username;
            document.getElementById('user-avatar').textContent = user.username[0].toUpperCase();
            initSocket();
            loadChannels();
            loadMessages();
        }

        function initSocket() {
            socket = io(URL);
            socket.on('connect', () => joinRoom());
            socket.on('new_message', msg => addMessage(msg));
            socket.on('user_joined_voice', data => handleUserJoinedVoice(data));
            socket.on('user_left_voice', data => handleUserLeftVoice(data));
            socket.on('webrtc_offer', handleOffer);
            socket.on('webrtc_answer', handleAnswer);
            socket.on('ice_candidate', handleIce);
        }

        async function loadChannels() {
            try {
                const res = await fetch(`${URL}/api/servers/${currentServer}/channels`);
                const channels = await res.json();
                const list = document.getElementById('channels-list');
                list.innerHTML = '';
                channels.forEach(ch => {
                    const div = document.createElement('div');
                    div.className = 'channel-item' + (ch.type === 'voice' ? ' voice' : '');
                    div.textContent = ch.name;
                    div.onclick = () => switchChannel(ch.id, ch.name, ch.type);
                    if (ch.id === currentChannel) div.classList.add('active');
                    list.appendChild(div);
                });
            } catch(e) {
                console.error(e);
            }
        }

        function switchChannel(id, name, type) {
            currentChannel = id;
            isDM = false;
            document.getElementById('channel-title').textContent = '# ' + name;
            document.getElementById('record-btn').style.display = 'none';
            
            if (type === 'voice') {
                document.getElementById('voice-controls').innerHTML = `
                    <button class="voice-btn" onclick="joinVoice()">Join Voice</button>
                `;
            } else {
                document.getElementById('voice-controls').innerHTML = '';
            }
            
            loadMessages();
            joinRoom();
            
            document.querySelectorAll('.channel-item').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
        }

        function joinRoom() {
            if (socket && socket.connected) {
                socket.emit('join_chat', {
                    server_id: currentServer,
                    channel_id: currentChannel,
                    username: user.username
                });
            }
        }

        async function loadMessages() {
            try {
                const res = await fetch(`${URL}/api/messages/${currentServer}/${currentChannel}`);
                const messages = await res.json();
                const container = document.getElementById('messages');
                container.innerHTML = '';
                messages.forEach(msg => addMessage(msg, false));
                container.scrollTop = container.scrollHeight;
            } catch(e) {
                console.error(e);
            }
        }

        function addMessage(msg, scroll = true) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = 'message';
            
            const time = new Date(msg.timestamp).toLocaleTimeString();
            const initial = msg.username[0].toUpperCase();
            
            let content = `<div class="msg-text">${escapeHtml(msg.content)}</div>`;
            if (msg.type === 'voice') {
                content = `
                    <div class="voice-msg">
                        <button class="voice-play" onclick="playVoice('${msg.content}')">â–¶</button>
                        <div class="voice-wave"></div>
                        <span class="voice-time">0:05</span>
                    </div>
                `;
            }
            
            div.innerHTML = `
                <div class="msg-avatar">${initial}</div>
                <div class="msg-content">
                    <div class="msg-header">
                        <span class="msg-author">${msg.username}</span>
                        <span class="msg-time">${time}</span>
                    </div>
                    ${content}
                </div>
            `;
            
            container.appendChild(div);
            if (scroll) container.scrollTop = container.scrollHeight;
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('msg-input');
            const content = input.value.trim();
            if (!content) return;
            
            try {
                await fetch(`${URL}/api/messages/send`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        server_id: currentServer,
                        channel_id: currentChannel,
                        user_email: user.email,
                        username: user.username,
                        content: content
                    })
                });
                
                socket.emit('send_message', {
                    server_id: currentServer,
                    channel_id: currentChannel,
                    username: user.username,
                    content: content,
                    timestamp: new Date().toISOString()
                });
                
                input.value = '';
            } catch(e) {
                console.error(e);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Voice
        async function joinVoice() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: { echoCancellation: true, noiseSuppression: true }
                });
                
                document.getElementById('voice-panel').classList.add('active');
                document.getElementById('voice-controls').innerHTML = '';
                
                socket.emit('voice_join', {
                    server_id: currentServer,
                    channel_id: currentChannel,
                    user_email: user.email,
                    username: user.username
                });
            } catch(e) {
                alert('Microphone access denied');
            }
        }

        function leaveVoice() {
            if (localStream) {
                localStream.getTracks().forEach(t => t.stop());
                localStream = null;
            }
            
            Object.values(peerConnections).forEach(pc => pc.close());
            peerConnections = {};
            
            document.getElementById('voice-panel').classList.remove('active');
            
            socket.emit('voice_leave', {
                server_id: currentServer,
                channel_id: currentChannel,
                user_email: user.email
            });
        }

        function toggleMute() {
            if (localStream) {
                const audio = localStream.getAudioTracks()[0];
                audio.enabled = !audio.enabled;
                event.target.textContent = audio.enabled ? 'ðŸ”‡' : 'ðŸ”Š';
            }
        }

        async function shareScreen() {
            try {
                screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                document.getElementById('screen-video').srcObject = screenStream;
                document.getElementById('screen-viewer').classList.add('active');
                screenStream.getVideoTracks()[0].onended = () => closeScreen();
            } catch(e) {
                console.error(e);
            }
        }

        function closeScreen() {
            if (screenStream) {
                screenStream.getTracks().forEach(t => t.stop());
                screenStream = null;
            }
            document.getElementById('screen-viewer').classList.remove('active');
        }

        // WebRTC
        async function handleUserJoinedVoice(data) {
            if (data.user_email === user.email || !localStream) return;
            
            try {
                const pc = new RTCPeerConnection(rtcConfig);
                peerConnections[data.user_email] = pc;
                
                localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
                
                pc.ontrack = e => {
                    const audio = document.createElement('audio');
                    audio.srcObject = e.streams[0];
                    audio.autoplay = true;
                    audio.id = 'audio-' + data.user_email;
                    document.body.appendChild(audio);
                };
                
                pc.onicecandidate = e => {
                    if (e.candidate) {
                        socket.emit('ice_candidate', {
                            target: data.user_email,
                            candidate: e.candidate,
                            from_user: user.email
                        });
                    }
                };
                
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                socket.emit('webrtc_offer', {
                    target: data.user_email,
                    offer: offer,
                    from_user: user.email
                });
            } catch(e) {
                console.error(e);
            }
        }

        async function handleOffer(data) {
            try {
                const pc = new RTCPeerConnection(rtcConfig);
                peerConnections[data.from_user] = pc;
                
                if (localStream) {
                    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
                }
                
                pc.ontrack = e => {
                    const audio = document.createElement('audio');
                    audio.srcObject = e.streams[0];
                    audio.autoplay = true;
                    audio.id = 'audio-' + data.from_user;
                    document.body.appendChild(audio);
                };
                
                pc.onicecandidate = e => {
                    if (e.candidate) {
                        socket.emit('ice_candidate', {
                            target: data.from_user,
                            candidate: e.candidate,
                            from_user: user.email
                        });
                    }
                };
                
                await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                
                socket.emit('webrtc_answer', {
                    target: data.from_user,
                    answer: answer,
                    from_user: user.email
                });
            } catch(e) {
                console.error(e);
            }
        }

        async function handleAnswer(data) {
            try {
                const pc = peerConnections[data.from_user];
                if (pc) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                }
            } catch(e) {
                console.error(e);
            }
        }

        async function handleIce(data) {
            try {
                const pc = peerConnections[data.from_user];
                if (pc) {
                    await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                }
            } catch(e) {
                console.error(e);
            }
        }

        function handleUserLeftVoice(data) {
            if (peerConnections[data.user_email]) {
                peerConnections[data.user_email].close();
                delete peerConnections[data.user_email];
            }
            const audio = document.getElementById('audio-' + data.user_email);
            if (audio) audio.remove();
        }

        // Voice Messages
        function toggleRecord() {
            const btn = document.getElementById('record-btn');
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                btn.classList.remove('recording');
            } else {
                startRecording();
                btn.classList.add('recording');
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioChunks = [];
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = e => {
                    audioChunks.push(e.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const base64 = reader.result.split(',')[1];
                        await sendVoiceMessage(base64);
                    };
                    reader.readAsDataURL(audioBlob);
                    stream.getTracks().forEach(t => t.stop());
                };
                
                mediaRecorder.start();
            } catch(e) {
                alert('Microphone access denied');
            }
        }

        async function sendVoiceMessage(base64) {
            try {
                await fetch(`${URL}/api/messages/send`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        server_id: currentServer,
                        channel_id: currentChannel,
                        user_email: user.email,
                        username: user.username,
                        content: base64,
                        type: 'voice'
                    })
                });
                
                socket.emit('send_message', {
                    server_id: currentServer,
                    channel_id: currentChannel,
                    username: user.username,
                    content: base64,
                    type: 'voice',
                    timestamp: new Date().toISOString()
                });
            } catch(e) {
                console.error(e);
            }
        }

        function playVoice(base64) {
            const audio = new Audio('data:audio/webm;base64,' + base64);
            audio.play();
        }

        // DM
        function showDM() {
            currentServer = 'dm';
            isDM = true;
            document.getElementById('server-name').textContent = 'Direct Messages';
            document.getElementById('channels-list').style.display = 'none';
            document.getElementById('dm-list').classList.add('active');
            document.getElementById('record-btn').style.display = 'block';
            loadFriends();
        }

        function showServer(id) {
            currentServer = id;
            isDM = false;
            document.getElementById('server-name').textContent = 'Welcome Server';
            document.getElementById('channels-list').style.display = 'block';
            document.getElementById('dm-list').classList.remove('active');
            document.getElementById('record-btn').style.display = 'none';
            loadChannels();
        }

        async function loadFriends() {
            try {
                const res = await fetch(`${URL}/api/friends/${user.email}`);
                const data = await res.json();
                const list = document.getElementById('dm-list');
                list.innerHTML = '';
                
                data.friends.forEach(friend => {
                    const div = document.createElement('div');
                    div.className = 'friend-item';
                    div.onclick = () => openDM(friend);
                    div.innerHTML = `
                        <div class="friend-avatar">${friend.username[0].toUpperCase()}</div>
                        <div class="friend-name">${friend.username}</div>
                    `;
                    list.appendChild(div);
                });
            } catch(e) {
                console.error(e);
            }
        }

        function openDM(friend) {
            currentChannel = 'dm_' + friend.email;
            document.getElementById('channel-title').textContent = '@ ' + friend.username;
            loadMessages();
            joinRoom();
        }
    </script>
</body>
</html>
