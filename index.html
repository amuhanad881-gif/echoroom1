<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo Room - Chat App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #app {
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Auth Container */
        .auth-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-container h1 {
            color: #667eea;
            margin-bottom: 10px;
            text-align: center;
            font-size: 2.5em;
        }

        .auth-container h2 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-weight: 400;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group textarea {
            height: 100px;
            resize: vertical;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
        }

        /* Main App Container */
        .main-container {
            display: flex;
            width: 100%;
            height: 100vh;
            background: #36393f;
        }

        /* Servers Sidebar */
        .servers-sidebar {
            width: 72px;
            background: #202225;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
            overflow-y: auto;
        }

        .server-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #36393f;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: border-radius 0.2s;
            position: relative;
        }

        .server-icon:hover {
            border-radius: 30%;
            background: #404249;
        }

        .server-icon.active {
            border-radius: 30%;
            background: #7289da;
        }

        .server-icon.home {
            background: #7289da;
        }

        .server-icon.add {
            background: #43b581;
        }

        .server-icon::before {
            content: '';
            position: absolute;
            left: -10px;
            width: 4px;
            height: 0;
            background: white;
            border-radius: 0 4px 4px 0;
            transition: height 0.2s;
        }

        .server-icon.active::before {
            height: 20px;
        }

        .server-icon:hover::before {
            height: 20px;
        }

        /* Main Sidebar */
        .sidebar {
            width: 240px;
            background: #2f3136;
            color: white;
            display: flex;
            flex-direction: column;
        }

        .server-header {
            padding: 20px;
            background: #202225;
            font-weight: bold;
            border-bottom: 2px solid #36393f;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .server-header:hover {
            background: #292b2f;
        }

        .channels {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }

        .channel-category {
            color: #8e9297;
            font-size: 12px;
            text-transform: uppercase;
            margin: 20px 0 5px 10px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .add-channel {
            cursor: pointer;
            padding: 0 5px;
        }

        .add-channel:hover {
            color: white;
        }

        .channel {
            padding: 8px 10px;
            margin: 2px 0;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            color: #8e9297;
            transition: background 0.2s;
        }

        .channel:hover {
            background: #36393f;
            color: #dcddde;
        }

        .channel.active {
            background: #404249;
            color: white;
        }

        .channel .icon {
            margin-right: 8px;
            font-size: 18px;
        }

        .voice-channel {
            color: #43b581;
        }

        /* Friends Section */
        .friends-section {
            border-top: 2px solid #202225;
            padding: 10px;
        }

        .section-header {
            color: #8e9297;
            font-size: 12px;
            text-transform: uppercase;
            padding: 5px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .section-header:hover {
            color: #dcddde;
        }

        .add-friend {
            font-size: 16px;
            cursor: pointer;
        }

        .friends-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .friend-item {
            padding: 5px 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
            border-radius: 5px;
        }

        .friend-item:hover {
            background: #36393f;
        }

        .friend-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
            background: #7289da;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            color: white;
            font-size: 14px;
            font-weight: 500;
        }

        .friend-status {
            color: #43b581;
            font-size: 12px;
        }

        .friend-request {
            padding: 10px;
            background: #404249;
            border-radius: 5px;
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .friend-request button {
            padding: 3px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: 600;
        }

        .friend-request button:first-of-type {
            background: #43b581;
            color: white;
        }

        .friend-request button:last-of-type {
            background: #f04747;
            color: white;
        }

        /* User Profile Section */
        .user-profile {
            padding: 10px;
            background: #292b2f;
            display: flex;
            align-items: center;
            cursor: pointer;
            border-top: 2px solid #202225;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #7289da;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
            color: white;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: white;
        }

        .user-status {
            font-size: 12px;
            color: #b9bbbe;
        }

        /* Main Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #36393f;
        }

        .chat-header {
            padding: 20px;
            background: #2f3136;
            color: white;
            border-bottom: 2px solid #202225;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .channel-info {
            display: flex;
            align-items: center;
        }

        .channel-name {
            font-size: 18px;
            font-weight: 600;
            margin-right: 10px;
        }

        .channel-topic {
            color: #8e9297;
            font-size: 14px;
        }

        .voice-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .voice-btn {
            padding: 8px 15px;
            background: #43b581;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
        }

        .voice-btn.leave {
            background: #f04747;
        }

        .voice-users {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }

        .voice-user {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #7289da;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            border: 2px solid #43b581;
        }

        /* Messages Container */
        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            display: flex;
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #7289da;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            overflow: hidden;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            align-items: baseline;
            margin-bottom: 5px;
        }

        .message-author {
            font-weight: 600;
            color: white;
            margin-right: 10px;
        }

        .message-time {
            font-size: 12px;
            color: #72767d;
        }

        .message-text {
            color: #dcddde;
            word-wrap: break-word;
        }

        /* Message Input */
        .message-input-container {
            padding: 20px;
            background: #40444b;
            margin: 0 20px 20px 20px;
            border-radius: 10px;
        }

        .message-input-wrapper {
            display: flex;
            align-items: center;
            background: #40444b;
        }

        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            padding: 10px;
            outline: none;
        }

        .message-input::placeholder {
            color: #72767d;
        }

        .emoji-picker-btn {
            background: none;
            border: none;
            color: #b9bbbe;
            font-size: 20px;
            cursor: pointer;
            padding: 0 10px;
        }

        .emoji-picker-btn:hover {
            color: white;
        }

        .send-btn {
            background: #7289da;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            margin-left: 10px;
        }

        .send-btn:hover {
            background: #677bc4;
        }

        /* Emoji Picker */
        .emoji-picker {
            position: absolute;
            bottom: 100px;
            right: 40px;
            background: #2f3136;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
        }

        .emoji-item {
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            text-align: center;
            border-radius: 5px;
        }

        .emoji-item:hover {
            background: #404249;
        }

        /* Profile Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #36393f;
            border-radius: 10px;
            padding: 30px;
            width: 450px;
            max-width: 90%;
            color: white;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #7289da;
        }

        .modal-content input,
        .modal-content textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #40444b;
            border: 1px solid #202225;
            border-radius: 5px;
            color: white;
            font-size: 16px;
        }

        .modal-content textarea {
            height: 100px;
            resize: vertical;
        }

        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 10px auto;
            background: #7289da;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        .save-btn {
            background: #7289da;
            color: white;
        }

        .cancel-btn {
            background: #40444b;
            color: white;
        }

        /* Typing Indicator */
        .typing-indicator {
            color: #72767d;
            font-size: 14px;
            padding: 5px 20px;
            font-style: italic;
        }

        /* Custom Emojis Section */
        .custom-emojis {
            margin-top: 20px;
            padding: 10px;
            background: #40444b;
            border-radius: 5px;
        }

        .custom-emojis h4 {
            color: #b9bbbe;
            margin-bottom: 10px;
        }

        .emoji-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .emoji-tag {
            background: #2f3136;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
        }

        .emoji-tag:hover {
            background: #404249;
        }

        .add-emoji {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .add-emoji input {
            flex: 1;
            padding: 5px;
            background: #2f3136;
            border: 1px solid #202225;
            color: white;
            border-radius: 3px;
        }

        .add-emoji button {
            padding: 5px 10px;
            background: #7289da;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        /* Camera Container */
        .camera-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            z-index: 1000;
            background: #2f3136;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .camera-container video {
            width: 100%;
            height: auto;
            display: block;
        }

        .camera-container .camera-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }

        /* Screen Share Container */
        .screen-share-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            background: #2f3136;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .screen-share-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .screen-share-container .screen-share-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f04747;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            z-index: 1001;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #2f3136;
        }

        ::-webkit-scrollbar-thumb {
            background: #202225;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #404249;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Auth Screen -->
        <div id="auth-screen" class="auth-container">
            <h1>üîä Echo Room</h1>
            <h2>Welcome Back!</h2>
            <div class="input-group">
                <label>Gmail Address</label>
                <input type="email" id="login-email" placeholder="example@gmail.com" value="test@gmail.com">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="password123">
            </div>
            <button class="btn" onclick="login()">Login</button>
            <button class="btn btn-secondary" onclick="showSignupForm()">Create Account</button>
            <p style="text-align: center; margin-top: 10px; color: #666; font-size: 12px;">
                One Gmail = One Account Only
            </p>
        </div>

        <!-- Main App Screen -->
        <div id="main-screen" class="main-container" style="display: none;">
            <!-- Servers Sidebar -->
            <div class="servers-sidebar">
                <div class="server-icon home" onclick="switchToDM()" title="Direct Messages">üè†</div>
                <div class="server-icon add" onclick="showCreateServerModal()" title="Create Server">‚ûï</div>
                <div id="server-list" class="server-list"></div>
            </div>

            <!-- Main Sidebar -->
            <div class="sidebar">
                <div class="server-header" onclick="showServerMenu()">
                    <span id="current-server-name">Welcome Server</span>
                    <span>‚ñº</span>
                </div>
                
                <div class="channels">
                    <div class="channel-category">
                        <span>TEXT CHANNELS</span>
                        <span class="add-channel" onclick="showCreateChannelModal('text')">‚ûï</span>
                    </div>
                    <div id="text-channels"></div>
                    
                    <div class="channel-category">
                        <span>VOICE CHANNELS</span>
                        <span class="add-channel" onclick="showCreateChannelModal('voice')">‚ûï</span>
                    </div>
                    <div id="voice-channels"></div>

                    <!-- Friends Section -->
                    <div class="friends-section">
                        <div class="section-header" onclick="toggleFriendsList()">
                            <span>FRIENDS</span>
                            <span class="add-friend" onclick="showFriendModal(event)">‚ûï</span>
                        </div>
                        <div id="friends-list" class="friends-list"></div>
                        <div id="friend-requests" class="friend-requests"></div>
                    </div>

                    <!-- Custom Emojis Section -->
                    <div class="custom-emojis">
                        <h4>Custom Emojis</h4>
                        <div id="emoji-list" class="emoji-list"></div>
                        <div class="add-emoji">
                            <input type="text" id="new-emoji-name" placeholder="name">
                            <input type="text" id="new-emoji-char" placeholder="emoji">
                            <button onclick="addCustomEmoji()">Add</button>
                        </div>
                    </div>
                </div>

                <!-- User Profile -->
                <div class="user-profile" onclick="openProfileModal()">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <div class="user-info">
                        <div class="user-name" id="user-name">User</div>
                        <div class="user-status" id="user-status">Online</div>
                    </div>
                </div>
            </div>

            <!-- Main Chat Area -->
            <div class="chat-area">
                <div class="chat-header">
                    <div class="channel-info">
                        <span class="channel-name" id="current-channel"># General</span>
                        <span class="channel-topic" id="channel-topic">Welcome to Echo Room!</span>
                    </div>
                    <div class="voice-controls" id="voice-controls" style="display: none;">
                        <button class="voice-btn" onclick="joinVoiceChannel()">üîä Join Voice</button>
                        <button class="voice-btn leave" onclick="leaveVoiceChannel()" style="display: none;">üîá Leave Voice</button>
                        <button class="voice-btn" id="screen-share-btn" onclick="startScreenShare()">üì∫ Share Screen</button>
                        <button class="voice-btn leave" id="stop-share-btn" onclick="stopScreenShare()" style="display: none;">‚èπÔ∏è Stop Share</button>
                        <button class="voice-btn" id="camera-btn" onclick="startCamera()">üì∑ Camera</button>
                        <button class="voice-btn leave" id="stop-camera-btn" onclick="stopCamera()" style="display: none;">‚èπÔ∏è Stop Camera</button>
                        <div id="voice-users" class="voice-users"></div>
                    </div>
                </div>

                <!-- Messages -->
                <div class="messages-container" id="messages">
                    <!-- Messages will be displayed here -->
                </div>

                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typing-indicator"></div>

                <!-- Message Input -->
                <div class="message-input-container">
                    <div class="message-input-wrapper">
                        <button class="emoji-picker-btn" onclick="toggleEmojiPicker()">üòä</button>
                        <input type="text" class="message-input" id="message-input" 
                               placeholder="Message #general" onkeypress="handleKeyPress(event)">
                        <button class="send-btn" onclick="sendMessage()">Send</button>
                    </div>
                </div>

                <!-- Emoji Picker -->
                <div id="emoji-picker" class="emoji-picker" style="display: none;"></div>
            </div>
        </div>

        <!-- Camera Container -->
        <div id="camera-container" class="camera-container" style="display: none;">
            <div class="camera-label">Your Camera</div>
            <button class="close-btn" onclick="stopCamera()">‚úï</button>
            <video id="local-video" autoplay muted></video>
        </div>

        <!-- Screen Share Container -->
        <div id="screen-share-container" class="screen-share-container" style="display: none;">
            <div class="screen-share-label">You are sharing your screen</div>
            <button class="close-btn" onclick="stopScreenShare()">‚úï</button>
            <video id="screen-share-video" autoplay muted></video>
        </div>

        <!-- Profile Modal -->
        <div id="profile-modal" class="modal">
            <div class="modal-content">
                <h2>Edit Profile</h2>
                <div class="avatar-preview" id="avatar-preview" onclick="uploadProfilePicture()">
                    <img id="profile-avatar-img" src="" alt="Avatar">
                </div>
                <input type="text" id="profile-username" placeholder="Username">
                <textarea id="profile-bio" placeholder="Bio"></textarea>
                <input type="text" id="profile-status" placeholder="Custom Status">
                <div class="modal-buttons">
                    <button class="modal-btn save-btn" onclick="saveProfile()">Save</button>
                    <button class="modal-btn cancel-btn" onclick="closeProfileModal()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Create Server Modal -->
        <div id="create-server-modal" class="modal">
            <div class="modal-content">
                <h2>Create Server</h2>
                <input type="text" id="server-name" placeholder="Server name">
                <input type="text" id="server-icon" placeholder="Server icon (emoji)" value="üéÆ">
                <div class="modal-buttons">
                    <button class="modal-btn save-btn" onclick="createServer()">Create</button>
                    <button class="modal-btn cancel-btn" onclick="closeCreateServerModal()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Create Channel Modal -->
        <div id="create-channel-modal" class="modal">
            <div class="modal-content">
                <h2>Create Channel</h2>
                <input type="text" id="channel-name" placeholder="Channel name">
                <div class="modal-buttons">
                    <button class="modal-btn save-btn" onclick="createChannel()">Create</button>
                    <button class="modal-btn cancel-btn" onclick="closeCreateChannelModal()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Friend Request Modal -->
        <div id="friend-modal" class="modal">
            <div class="modal-content">
                <h2>Add Friend</h2>
                <input type="text" id="friend-username" placeholder="Enter username">
                <div class="modal-buttons">
                    <button class="modal-btn save-btn" onclick="sendFriendRequest()">Send Request</button>
                    <button class="modal-btn cancel-btn" onclick="closeFriendModal()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Server Menu Modal -->
        <div id="server-menu-modal" class="modal">
            <div class="modal-content" style="width: 300px;">
                <h2>Server Settings</h2>
                <button class="btn" onclick="showInviteUsers()">Invite Users</button>
                <button class="btn" onclick="showServerMembers()">View Members</button>
                <button class="btn btn-danger" onclick="leaveServer()">Leave Server</button>
                <div class="modal-buttons">
                    <button class="modal-btn cancel-btn" onclick="closeServerMenu()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Socket.io -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // Global variables
        let socket;
        let currentUser = null;
        let currentServer = 'welcome-server';
        let currentChannel = 'general';
        let servers = {};
        let channels = {};
        let emojis = {};
        let typingTimeout;
        let friends = [];
        let friendRequests = [];
        
        // Media variables
        let localStream = null;
        let screenStream = null;
        let peerConnections = {};

        // Server URL - automatically uses current host (works on Railway, localhost, etc)
        const SERVER_URL = window.location.origin;

        console.log('Connecting to server:', SERVER_URL);

        // Check for existing session on page load
        async function checkExistingSession() {
            const sessionToken = localStorage.getItem('echo_session_token');
            if (sessionToken) {
                try {
                    const response = await fetch(`${SERVER_URL}/api/auth/session/${sessionToken}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        currentUser = data.user;
                        showMainApp();
                        return true;
                    }
                } catch (error) {
                    console.error('Session check error:', error);
                }
            }
            return false;
        }

        // Save session
        function saveSession() {
            if (!currentUser) return;
            const sessionToken = localStorage.getItem('echo_session_token');
            if (!sessionToken) {
                const newToken = 'session_' + Math.random().toString(36).substring(2) + Date.now().toString(36);
                localStorage.setItem('echo_session_token', newToken);
                
                fetch(`${SERVER_URL}/api/auth/session`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: currentUser.email,
                        session_token: newToken
                    })
                }).catch(err => console.error('Session save error:', err));
            }
        }

        // Initialize socket connection
        function initSocket() {
            try {
                socket = io(SERVER_URL, {
                    reconnectionAttempts: 10,
                    reconnectionDelay: 1000,
                    timeout: 10000,
                    transports: ['polling', 'websocket']
                });
                
                socket.on('connect', () => {
                    console.log('‚úÖ Connected to server');
                    document.getElementById('typing-indicator').textContent = '';
                    if (currentUser) {
                        socket.emit('join_chat', {
                            server_id: currentServer,
                            channel_id: currentChannel,
                            username: currentUser.username
                        });
                    }
                });
                
                socket.on('connect_error', (error) => {
                    console.log('‚ùå Connection error:', error);
                    document.getElementById('typing-indicator').textContent = '‚ö†Ô∏è Connecting to server...';
                });
                
                socket.on('disconnect', () => {
                    console.log('Disconnected from server');
                    document.getElementById('typing-indicator').textContent = '‚ö†Ô∏è Reconnecting...';
                });

                socket.on('new_message', (data) => {
                    if (data.server_id === currentServer && data.channel_id === currentChannel) {
                        displayMessage(data.message);
                    }
                });

                socket.on('user_typing', (data) => {
                    document.getElementById('typing-indicator').textContent = 
                        `${data.username} is typing...`;
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => {
                        document.getElementById('typing-indicator').textContent = '';
                    }, 3000);
                });

                socket.on('user_joined_chat', (data) => {
                    console.log(`${data.username} joined the chat`);
                });

                socket.on('channel_created', (data) => {
                    if (data.server_id === currentServer) {
                        loadChannels(currentServer);
                    }
                });

                socket.on('server_created', (server) => {
                    loadUserServers();
                });

                socket.on('emoji_added', (data) => {
                    emojis[data.name] = data.emoji;
                    updateEmojiList();
                });

                // WebRTC signaling events
                socket.on('webrtc_offer', handleWebRTCOffer);
                socket.on('webrtc_answer', handleWebRTCAnswer);
                socket.on('ice_candidate', handleICECandidate);
            } catch (error) {
                console.error('Socket initialization error:', error);
            }
        }

        // WebRTC handlers
        async function handleWebRTCOffer(data) {
            // Implement WebRTC offer handling
            console.log('Received WebRTC offer from:', data.from_user);
        }

        async function handleWebRTCAnswer(data) {
            console.log('Received WebRTC answer from:', data.from_user);
        }

        async function handleICECandidate(data) {
            console.log('Received ICE candidate from:', data.from_user);
        }

        // Authentication functions
        function showSignupForm() {
            document.getElementById('auth-screen').innerHTML = `
                <h1>üîä Echo Room</h1>
                <h2>Create Account</h2>
                <div class="input-group">
                    <label>Gmail Address</label>
                    <input type="email" id="signup-email" placeholder="example@gmail.com" value="test@gmail.com">
                </div>
                <div class="input-group">
                    <label>Username</label>
                    <input type="text" id="signup-username" placeholder="Choose a username" value="testuser">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="signup-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="password123">
                </div>
                <div class="input-group">
                    <label>Bio (optional)</label>
                    <textarea id="signup-bio" placeholder="Tell us about yourself"></textarea>
                </div>
                <button class="btn" onclick="signup()">Sign Up</button>
                <button class="btn btn-secondary" onclick="showLoginForm()">Already have an account? Login</button>
                <p style="text-align: center; margin-top: 10px; color: #666; font-size: 12px;">
                    One Gmail = One Account Only
                </p>
            `;
        }

        function showLoginForm() {
            document.getElementById('auth-screen').innerHTML = `
                <h1>üîä Echo Room</h1>
                <h2>Welcome Back!</h2>
                <div class="input-group">
                    <label>Gmail Address</label>
                    <input type="email" id="login-email" placeholder="example@gmail.com" value="test@gmail.com">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="password123">
                </div>
                <button class="btn" onclick="login()">Login</button>
                <button class="btn btn-secondary" onclick="showSignupForm()">Create Account</button>
                <p style="text-align: center; margin-top: 10px; color: #666; font-size: 12px;">
                    One Gmail = One Account Only
                </p>
            `;
        }

        async function signup() {
            const email = document.getElementById('signup-email').value;
            const username = document.getElementById('signup-username').value;
            const password = document.getElementById('signup-password').value;
            const bio = document.getElementById('signup-bio').value;
            
            if (!email || !username || !password) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                console.log('Attempting to sign up...');
                const response = await fetch(`${SERVER_URL}/api/auth/signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        email: email, 
                        username: username, 
                        password: password, 
                        bio: bio 
                    })
                });
                
                const data = await response.json();
                console.log('Signup response:', data);
                
                if (data.success) {
                    currentUser = data.user;
                    if (data.session_token) {
                        localStorage.setItem('echo_session_token', data.session_token);
                    }
                    showMainApp();
                } else {
                    alert(data.error || 'Signup failed');
                }
            } catch (error) {
                console.error('Signup error:', error);
                alert('Signup failed. Make sure the server is running at ' + SERVER_URL);
            }
        }

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }

            try {
                console.log('Attempting to login...');
                const response = await fetch(`${SERVER_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        email: email, 
                        password: password 
                    })
                });

                const data = await response.json();
                console.log('Login response:', data);
                
                if (data.success) {
                    currentUser = data.user;
                    if (data.session_token) {
                        localStorage.setItem('echo_session_token', data.session_token);
                    }
                    showMainApp();
                } else {
                    alert(data.error || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Make sure the server is running at ' + SERVER_URL);
            }
        }

        async function logout() {
            const sessionToken = localStorage.getItem('echo_session_token');
            if (sessionToken) {
                try {
                    await fetch(`${SERVER_URL}/api/auth/logout`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ session_token: sessionToken })
                    });
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }
            localStorage.removeItem('echo_session_token');
            currentUser = null;
            location.reload();
        }

        function showMainApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-screen').style.display = 'flex';
            
            // Save session
            saveSession();
            
            // Update user info
            updateUserDisplay();
            
            // Initialize socket
            initSocket();
            
            // Load data
            loadUserServers();
            loadFriends();
            loadEmojis();
        }

        function updateUserDisplay() {
            document.getElementById('user-name').textContent = currentUser.username;
            document.getElementById('user-status').textContent = currentUser.custom_status || 'Online';
            
            const userAvatar = document.getElementById('user-avatar');
            if (currentUser.avatar) {
                userAvatar.innerHTML = `<img src="${currentUser.avatar}" alt="Avatar">`;
            } else {
                userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
            }
        }

        // Server functions
        async function loadUserServers() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${SERVER_URL}/api/servers/user/${currentUser.email}`);
                servers = await response.json();
                
                const serverList = document.getElementById('server-list');
                serverList.innerHTML = '';
                
                servers.forEach(server => {
                    const serverElement = document.createElement('div');
                    serverElement.className = `server-icon ${server.id === currentServer ? 'active' : ''}`;
                    serverElement.textContent = server.icon || 'üéÆ';
                    serverElement.title = server.name;
                    serverElement.onclick = () => switchServer(server);
                    serverList.appendChild(serverElement);
                });
                
                // Load channels for current server
                if (servers.length > 0) {
                    loadChannels(currentServer);
                }
            } catch (error) {
                console.error('Error loading servers:', error);
            }
        }

        async function switchServer(server) {
            currentServer = server.id;
            document.querySelectorAll('.server-icon').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById('current-server-name').textContent = server.name;
            
            await loadChannels(server.id);
        }

        async function loadChannels(serverId) {
            try {
                const response = await fetch(`${SERVER_URL}/api/servers/${serverId}/channels`);
                const channelList = await response.json();
                
                channels = channelList.reduce((acc, channel) => {
                    acc[channel.id] = channel;
                    return acc;
                }, {});
                
                const textChannels = document.getElementById('text-channels');
                const voiceChannels = document.getElementById('voice-channels');
                
                textChannels.innerHTML = '';
                voiceChannels.innerHTML = '';
                
                channelList.forEach(channel => {
                    const channelElement = document.createElement('div');
                    channelElement.className = `channel ${channel.type === 'voice' ? 'voice-channel' : ''}`;
                    channelElement.onclick = () => switchChannel(channel);
                    
                    const icon = channel.type === 'voice' ? 'üîä' : '#';
                    channelElement.innerHTML = `
                        <span class="icon">${icon}</span>
                        ${channel.name}
                    `;
                    
                    if (channel.type === 'voice') {
                        voiceChannels.appendChild(channelElement);
                    } else {
                        textChannels.appendChild(channelElement);
                    }
                });
                
                // Load messages for current channel
                const firstTextChannel = channelList.find(c => c.type === 'text');
                if (firstTextChannel) {
                    switchChannel(firstTextChannel);
                }
            } catch (error) {
                console.error('Error loading channels:', error);
            }
        }

        function switchChannel(channel) {
            currentChannel = channel.id;
            document.getElementById('current-channel').textContent = `# ${channel.name}`;
            
            // Update active state
            document.querySelectorAll('.channel').forEach(el => {
                el.classList.remove('active');
            });
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
            
            // Show/hide voice controls
            if (channel.type === 'voice') {
                document.getElementById('voice-controls').style.display = 'flex';
            } else {
                document.getElementById('voice-controls').style.display = 'none';
                // Stop camera and screen share when leaving voice channel
                stopCamera();
                stopScreenShare();
            }
            
            // Load messages for this channel
            loadMessages(currentServer, channel.id);
            
            // Join channel room
            if (socket && socket.connected) {
                socket.emit('join_chat', {
                    server_id: currentServer,
                    channel_id: channel.id,
                    username: currentUser.username
                });
            }
        }

        function switchToDM() {
            alert('Direct Messages - Coming soon!');
        }

        // Message functions
        async function loadMessages(serverId, channelId) {
            try {
                const response = await fetch(`${SERVER_URL}/api/messages/${serverId}/${channelId}`);
                const messages = await response.json();
                
                const messagesContainer = document.getElementById('messages');
                messagesContainer.innerHTML = '';
                
                messages.forEach(message => {
                    displayMessage(message);
                });
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        function displayMessage(message) {
            const messagesContainer = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            
            const time = new Date(message.timestamp).toLocaleTimeString();
            
            let content = message.content;
            // Replace emoji shortcodes
            Object.keys(emojis).forEach(key => {
                const regex = new RegExp(`:${key}:`, 'g');
                content = content.replace(regex, emojis[key]);
            });
            
            const avatarHtml = message.avatar ? 
                `<img src="${message.avatar}" alt="Avatar">` : 
                message.username.charAt(0).toUpperCase();
            
            messageElement.innerHTML = `
                <div class="message-avatar">${avatarHtml}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${message.username}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${content}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            
            if (!content || !currentUser) return;
            
            try {
                const response = await fetch(`${SERVER_URL}/api/messages/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        server_id: currentServer,
                        channel_id: currentChannel,
                        user_email: currentUser.email,
                        username: currentUser.username,
                        avatar: currentUser.avatar || '',
                        content: content
                    })
                });
                
                const message = await response.json();
                input.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
            
            // Emit typing event
            if (socket && socket.connected && currentUser) {
                socket.emit('typing', {
                    server_id: currentServer,
                    channel_id: currentChannel,
                    username: currentUser.username
                });
            }
        }

        // Friend functions
        async function loadFriends() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${SERVER_URL}/api/friends/list/${currentUser.email}`);
                const data = await response.json();
                
                friends = data.friends || [];
                friendRequests = data.requests || [];
                
                updateFriendsList();
                updateFriendRequests();
            } catch (error) {
                console.error('Error loading friends:', error);
            }
        }

        function updateFriendsList() {
            const friendsList = document.getElementById('friends-list');
            friendsList.innerHTML = '';
            
            friends.forEach(friend => {
                const friendElement = document.createElement('div');
                friendElement.className = 'friend-item';
                
                friendElement.innerHTML = `
                    <div class="friend-avatar">${friend.username.charAt(0)}</div>
                    <div class="friend-info">
                        <div class="friend-name">${friend.username}</div>
                        <div class="friend-status">${friend.status}</div>
                    </div>
                `;
                friendElement.onclick = () => startDM(friend);
                friendsList.appendChild(friendElement);
            });
        }

        function updateFriendRequests() {
            const requestsList = document.getElementById('friend-requests');
            requestsList.innerHTML = '';
            
            friendRequests.forEach(request => {
                const requestElement = document.createElement('div');
                requestElement.className = 'friend-request';
                requestElement.innerHTML = `
                    <span>${request.from_username} wants to be friends</span>
                    <button onclick="acceptFriendRequest('${request.from_email}')">‚úì</button>
                    <button onclick="rejectFriendRequest('${request.from_email}')">‚úó</button>
                `;
                requestsList.appendChild(requestElement);
            });
        }

        function showFriendModal(event) {
            event.stopPropagation();
            document.getElementById('friend-modal').classList.add('active');
        }

        function closeFriendModal() {
            document.getElementById('friend-modal').classList.remove('active');
            document.getElementById('friend-username').value = '';
        }

        async function sendFriendRequest() {
            const username = document.getElementById('friend-username').value.trim();
            
            if (!username) {
                alert('Please enter a username');
                return;
            }
            
            try {
                const response = await fetch(`${SERVER_URL}/api/friends/request`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        from_email: currentUser.email,
                        to_username: username
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Friend request sent!');
                    closeFriendModal();
                } else {
                    alert(data.error || 'Failed to send request');
                }
            } catch (error) {
                console.error('Error sending friend request:', error);
            }
        }

        async function acceptFriendRequest(email) {
            try {
                const response = await fetch(`${SERVER_URL}/api/friends/accept`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_email: currentUser.email,
                        request_email: email
                    })
                });
                
                if (response.ok) {
                    loadFriends();
                }
            } catch (error) {
                console.error('Error accepting friend request:', error);
            }
        }

        async function rejectFriendRequest(email) {
            try {
                const response = await fetch(`${SERVER_URL}/api/friends/reject`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_email: currentUser.email,
                        request_email: email
                    })
                });
                
                if (response.ok) {
                    loadFriends();
                }
            } catch (error) {
                console.error('Error rejecting friend request:', error);
            }
        }

        function toggleFriendsList() {
            const friendsList = document.getElementById('friends-list');
            const requestsList = document.getElementById('friend-requests');
            
            if (friendsList.style.display === 'none') {
                friendsList.style.display = 'block';
                requestsList.style.display = 'block';
            } else {
                friendsList.style.display = 'none';
                requestsList.style.display = 'none';
            }
        }

        function startDM(friend) {
            alert(`Starting DM with ${friend.username} - Coming soon!`);
        }

        // Profile functions
        function openProfileModal() {
            if (!currentUser) return;
            
            document.getElementById('profile-modal').classList.add('active');
            document.getElementById('profile-username').value = currentUser.username || '';
            document.getElementById('profile-bio').value = currentUser.bio || '';
            document.getElementById('profile-status').value = currentUser.custom_status || '';
            
            const avatarPreview = document.getElementById('profile-avatar-img');
            if (currentUser.avatar) {
                avatarPreview.src = currentUser.avatar;
            } else {
                avatarPreview.src = '';
            }
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.remove('active');
        }

        async function saveProfile() {
            const username = document.getElementById('profile-username').value;
            const bio = document.getElementById('profile-bio').value;
            const status = document.getElementById('profile-status').value;
            
            if (!username) {
                alert('Username cannot be empty');
                return;
            }
            
            try {
                const response = await fetch(`${SERVER_URL}/api/user/update`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: currentUser.email,
                        username,
                        bio,
                        custom_status: status
                    })
                });
                
                if (response.ok) {
                    currentUser.username = username;
                    currentUser.bio = bio;
                    currentUser.custom_status = status;
                    
                    updateUserDisplay();
                    closeProfileModal();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to update profile');
                }
            } catch (error) {
                console.error('Error saving profile:', error);
            }
        }

        function uploadProfilePicture() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    const avatarData = e.target.result;
                    
                    try {
                        const response = await fetch(`${SERVER_URL}/api/user/update`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                email: currentUser.email,
                                avatar: avatarData
                            })
                        });
                        
                        if (response.ok) {
                            currentUser.avatar = avatarData;
                            document.getElementById('profile-avatar-img').src = avatarData;
                            updateUserDisplay();
                        }
                    } catch (error) {
                        console.error('Error uploading avatar:', error);
                    }
                };
                
                reader.readAsDataURL(file);
            };
            
            input.click();
        }

        // Server creation functions
        function showCreateServerModal() {
            document.getElementById('create-server-modal').classList.add('active');
        }

        function closeCreateServerModal() {
            document.getElementById('create-server-modal').classList.remove('active');
            document.getElementById('server-name').value = '';
            document.getElementById('server-icon').value = 'üéÆ';
        }

        async function createServer() {
            const name = document.getElementById('server-name').value.trim();
            const icon = document.getElementById('server-icon').value.trim() || 'üéÆ';
            
            if (!name) {
                alert('Please enter a server name');
                return;
            }
            
            try {
                const response = await fetch(`${SERVER_URL}/api/servers/create`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name,
                        icon,
                        owner_email: currentUser.email
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeCreateServerModal();
                    loadUserServers();
                } else {
                    alert(data.error || 'Failed to create server');
                }
            } catch (error) {
                console.error('Error creating server:', error);
            }
        }

        // Channel creation functions
        let newChannelType = 'text';
        
        function showCreateChannelModal(type) {
            newChannelType = type;
            document.getElementById('create-channel-modal').classList.add('active');
        }

        function closeCreateChannelModal() {
            document.getElementById('create-channel-modal').classList.remove('active');
            document.getElementById('channel-name').value = '';
        }

        async function createChannel() {
            const name = document.getElementById('channel-name').value.trim();
            
            if (!name) {
                alert('Please enter a channel name');
                return;
            }
            
            try {
                const response = await fetch(`${SERVER_URL}/api/channels/create`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        server_id: currentServer,
                        name: name,
                        type: newChannelType
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeCreateChannelModal();
                    loadChannels(currentServer);
                } else {
                    alert(data.error || 'Failed to create channel');
                }
            } catch (error) {
                console.error('Error creating channel:', error);
                alert('Failed to create channel');
            }
        }

        // Server menu functions
        function showServerMenu() {
            document.getElementById('server-menu-modal').classList.add('active');
        }

        function closeServerMenu() {
            document.getElementById('server-menu-modal').classList.remove('active');
        }

        function showInviteUsers() {
            const inviteCode = Math.random().toString(36).substring(2, 8);
            alert(`Share this invite code: ${inviteCode}\n\nInvite users to join your server!`);
        }

        function showServerMembers() {
            alert('Member list - Coming soon!');
        }

        async function leaveServer() {
            if (!currentServer || currentServer === 'welcome-server') {
                alert('Cannot leave the welcome server');
                closeServerMenu();
                return;
            }
            
            if (confirm('Are you sure you want to leave this server?')) {
                try {
                    const response = await fetch(`${SERVER_URL}/api/servers/leave`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            server_id: currentServer,
                            user_email: currentUser.email
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        closeServerMenu();
                        // Switch to welcome server
                        currentServer = 'welcome-server';
                        loadUserServers();
                    } else {
                        alert(data.error || 'Failed to leave server');
                    }
                } catch (error) {
                    console.error('Error leaving server:', error);
                    alert('Failed to leave server');
                }
            }
        }

        // Voice chat functions
        async function joinVoiceChannel() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Show voice controls
                document.querySelector('.voice-btn').style.display = 'none';
                document.querySelector('.voice-btn.leave').style.display = 'block';
                
                // Notify others
                if (socket && socket.connected) {
                    socket.emit('voice_join', {
                        server_id: currentServer,
                        channel_id: currentChannel,
                        user_email: currentUser.email,
                        username: currentUser.username
                    });
                }
                
                alert('Voice chat activated! (Full WebRTC implementation coming soon)');
            } catch (error) {
                console.error('Error joining voice:', error);
                alert('Could not access microphone. Please check permissions.');
            }
        }

        function leaveVoiceChannel() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            document.querySelector('.voice-btn').style.display = 'block';
            document.querySelector('.voice-btn.leave').style.display = 'none';
            
            if (socket && socket.connected) {
                socket.emit('voice_leave', {
                    server_id: currentServer,
                    channel_id: currentChannel,
                    user_email: currentUser.email
                });
            }
        }

        // Screen share functions
        async function startScreenShare() {
            try {
                screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                    video: true,
                    audio: true 
                });
                
                const videoElement = document.getElementById('screen-share-video');
                videoElement.srcObject = screenStream;
                
                document.getElementById('screen-share-container').style.display = 'block';
                document.getElementById('screen-share-btn').style.display = 'none';
                document.getElementById('stop-share-btn').style.display = 'block';
                
                // Handle when user stops sharing via browser UI
                screenStream.getVideoTracks()[0].onended = () => {
                    stopScreenShare();
                };
                
                // Notify others (WebRTC implementation coming soon)
                alert('Screen sharing activated! (Full WebRTC implementation coming soon)');
                
            } catch (error) {
                console.error('Screen share error:', error);
                alert('Could not start screen share');
            }
        }

        function stopScreenShare() {
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }
            
            document.getElementById('screen-share-container').style.display = 'none';
            document.getElementById('screen-share-btn').style.display = 'block';
            document.getElementById('stop-share-btn').style.display = 'none';
        }

        // Camera functions
        async function startCamera() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true,
                    audio: true 
                });
                
                const videoElement = document.getElementById('local-video');
                videoElement.srcObject = localStream;
                
                document.getElementById('camera-container').style.display = 'block';
                document.getElementById('camera-btn').style.display = 'none';
                document.getElementById('stop-camera-btn').style.display = 'block';
                
                // Notify others (WebRTC implementation coming soon)
                alert('Camera activated! (Full WebRTC implementation coming soon)');
                
            } catch (error) {
                console.error('Camera error:', error);
                alert('Could not access camera');
            }
        }

        function stopCamera() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            document.getElementById('camera-container').style.display = 'none';
            document.getElementById('camera-btn').style.display = 'block';
            document.getElementById('stop-camera-btn').style.display = 'none';
        }

        // Emoji functions
        async function loadEmojis() {
            try {
                const response = await fetch(`${SERVER_URL}/api/emojis`);
                emojis = await response.json();
                updateEmojiList();
            } catch (error) {
                console.error('Error loading emojis:', error);
            }
        }

        function updateEmojiList() {
            const emojiList = document.getElementById('emoji-list');
            emojiList.innerHTML = '';
            
            Object.entries(emojis).forEach(([name, emoji]) => {
                const emojiElement = document.createElement('span');
                emojiElement.className = 'emoji-tag';
                emojiElement.textContent = emoji;
                emojiElement.title = `:${name}:`;
                emojiElement.onclick = () => {
                    document.getElementById('message-input').value += emoji;
                };
                emojiList.appendChild(emojiElement);
            });
        }

        async function addCustomEmoji() {
            const name = document.getElementById('new-emoji-name').value.trim();
            const emoji = document.getElementById('new-emoji-char').value.trim();
            
            if (!name || !emoji) {
                alert('Please enter both name and emoji');
                return;
            }
            
            try {
                await fetch(`${SERVER_URL}/api/emojis/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, emoji })
                });
                
                document.getElementById('new-emoji-name').value = '';
                document.getElementById('new-emoji-char').value = '';
            } catch (error) {
                console.error('Error adding emoji:', error);
            }
        }

        function toggleEmojiPicker() {
            const picker = document.getElementById('emoji-picker');
            if (picker.style.display === 'none') {
                picker.style.display = 'grid';
                updateEmojiPicker();
            } else {
                picker.style.display = 'none';
            }
        }

        function updateEmojiPicker() {
            const picker = document.getElementById('emoji-picker');
            picker.innerHTML = '';
            
            Object.entries(emojis).forEach(([name, emoji]) => {
                const emojiElement = document.createElement('div');
                emojiElement.className = 'emoji-item';
                emojiElement.textContent = emoji;
                emojiElement.onclick = () => {
                    document.getElementById('message-input').value += emoji;
                    picker.style.display = 'none';
                };
                picker.appendChild(emojiElement);
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            const hasSession = await checkExistingSession();
            if (!hasSession) {
                showLoginForm();
            }
        });
    </script>
</body>
</html>